(in-package :cl-user)
(defpackage noaa-solar-calculator-test
  (:use :cl :fiveam)
  (:import-from :noaa-solar-calculator
                :equation-of-time
                :mean-obliquity-of-ecliptic
                :jd
                :time-local
                :time-julian-cent
                :obliquity-correction
                :geom-mean-long-sun
                :eccentricity-earth-orbit
                :geom-mean-anomaly-sun
                :sun-declination
                :sun-apparent-long
                :sun-true-long
                :sun-rad-vector
                :sun-true-anomaly
                :sun-eq-of-center
                :refraction-correction
                :az-el
                :sol-noon
                :hour-angle-sunrise
                :leap-year-p
                :doy-from-jd
                :rise-set-utc
                :jd-of-next-prev-rise-set
                :todays-sun-rise-set
                :no-sun-rise-set-today))

(in-package :noaa-solar-calculator-test)

(eval-when (:compile-toplevel :load-toplevel :execute)
  (defparameter *previous-read-default-float-format* *read-default-float-format*)
  (setf *read-default-float-format* 'double-float))

(def-suite tests
  :description "NOAA Solar Calculator tests.")
(in-suite tests)

(defun calculate-error (val ref)
  (abs (/ (- val ref) ref)))

(defun compare (fun lst)
  (loop for (a b) on lst by #'cddr
     do (is (equal (if (consp b) b (list b))
                   (multiple-value-list (apply fun (if (listp a) a (list a))))))))

(defun compare-within-error (allow-error fun lst)
  (loop for (a b) on lst by #'cddr
     do (is (plusp (- allow-error (calculate-error (apply fun (if (listp a) a (list a))) b))))))

(defun compare-az-el (allow-error data)
  (loop for (args ref) on data by #'cddr
     do (let ((out (multiple-value-list (apply #'az-el args))))
          (loop for idx in (list 0 1 3 4 5) do
               (is (> allow-error (calculate-error (nth idx out) (nth idx ref)))))
          (is (equal (nth 2 out) (nth 2 ref))))))

(test todays-sun-rise-set-test
  (let ((data' ((:rise 2457388.5 52.268157 4.921875 1) (128.36336083541045 529.8614871768145)
                (:set 2457388.5 52.268157 4.921875 1) (231.6864507678405 997.5752244237565)
                (:rise 2457419.5 52.268157 4.921875 1) (117.7298837783608 502.13352463942283)
                (:set 2457419.5 52.268157 4.921875 1) (242.45813413973787 1046.1761688631975)
                (:rise 2457448.5 52.268157 4.921875 1) (101.05170132758185 445.6913556935613)
                (:set 2457448.5 52.268157 4.921875 1) (259.23387429963066 1100.3300852463628)
                (:rise 2457479.5 52.268157 4.921875 1) (81.2021519369012 374.1643279765956)
                (:set 2457479.5 52.268157 4.921875 1) (279.1414749877949 1154.9905269693656)
                (:rise 2457509.5 52.268157 4.921875 1) (63.44182596750409 309.153468467318)
                (:set 2457509.5 52.268157 4.921875 1) (296.88730308629334 1206.6964104099193)
                (:rise 2457540.5 52.268157 4.921875 1) (50.68290755615041 264.5968337167384)
                (:set 2457540.5 52.268157 4.921875 1) (309.4932650947444 1252.5094298236224)
                (:rise 2457570.5 52.268157 4.921875 1) (48.74755093687318 263.3947852662942)
                (:set 2457570.5 52.268157 4.921875 1) (311.1523172146743 1264.7682307640782)
                (:rise 2457601.5 52.268157 4.921875 1) (58.57259781315037 301.5415179812939)
                (:set 2457601.5 52.268157 4.921875 1) (301.1274327408232 1230.6502805833493)
                (:rise 2457632.5 52.268157 4.921875 1) (75.54055317107766 352.15209780381304)
                (:set 2457632.5 52.268157 4.921875 1) (284.114798339413 1167.1065424055973)
                (:rise 2457662.5 52.268157 4.921875 1) (94.4202502786267 401.88471815267826)
                (:set 2457662.5 52.268157 4.921875 1) (265.27322281742806 1096.84589363212)
                (:rise 2457693.5 52.268157 4.921875 1) (113.11871915229185 456.4817576525096)
                (:set 2457693.5 52.268157 4.921875 1) (246.66306597755806 1030.4756516760306)
                (:rise 2457723.5 52.268157 4.921875 1) (126.16717424042076 507.68289827947603)
                (:set 2457723.5 52.268157 4.921875 1) (233.73764494498525 990.9952381963175)
                (:rise 2457723.5 69.411242 22.8515625 1) nil
                (:set 2457723.5 69.411242 22.8515625 1) nil
                (:rise 2457388.5 69.411242 22.8515625 1) nil
                (:set 2457388.5 69.411242 22.8515625 1) nil
                (:rise 2457419.5 69.411242 22.8515625 1) (143.44591518314718 547.8102631629727)
                (:set 2457419.5 69.411242 22.8515625 1) (216.82657257622117 857.5129338299746)
                (:rise 2457448.5 69.411242 22.8515625 1) (109.14872395796664 411.78876948199303)
                (:set 2457448.5 69.411242 22.8515625 1) (251.30629768752618 991.627291797755)
                (:rise 2457479.5 69.411242 22.8515625 1) (74.28656808728005 272.2549017527723)
                (:set 2457479.5 69.411242 22.8515625 1) (286.3753665634089 1114.8941259909104)
                (:rise 2457509.5 69.411242 22.8515625 1) (38.53350549572639 126.46323346717497)
                (:set 2457509.5 69.411242 22.8515625 1) (322.5035359312713 1249.0260029774151)
                (:rise 2457540.5 69.411242 22.8515625 1) nil
                (:set 2457540.5 69.411242 22.8515625 1) nil
                (:rise 2457570.5 69.411242 22.8515625 1) nil
                (:set 2457570.5 69.411242 22.8515625 1) nil
                (:rise 2457601.5 69.411242 22.8515625 1) (23.75558931541758 75.13529635092853)
                (:set 2457601.5 69.411242 22.8515625 1) (334.8106910514688 1308.724975598825)
                (:rise 2457632.5 69.411242 22.8515625 1) (63.76407111628362 228.44397669271123)
                (:set 2457632.5 69.411242 22.8515625 1) (295.5074143461802 1145.735437230439)
                (:rise 2457662.5 69.411242 22.8515625 1) (97.31625660769356 344.47240921911344)
                (:set 2457662.5 69.411242 22.8515625 1) (262.1685049695575 1009.8904587063555)
                (:rise 2457693.5 69.411242 22.8515625 1) (132.64506268868772 474.28193538539574)
                (:set 2457693.5 69.411242 22.8515625 1) (227.02544010457626 868.6608206791248))))
    (loop for (a b) on data by #'cddr
       for output = (handler-case (multiple-value-list (apply #'todays-sun-rise-set a))
                      (no-sun-rise-set-today () nil))
       do (if (null b)
              (is-true (null output))
              (progn (is (> 1e-15 (calculate-error (first b) (first output))))
                     (is (> 1e-15 (calculate-error (second b) (second output)))))))))

(test jd-of-next-prev-rise-set
  (compare #'jd-of-next-prev-rise-set
           '((:next :rise 2457388.5 68.72044 21.2695312 1) (2457397.5 686.129837467808)
             (:prev :set 2457388.5 68.72044 21.2695312 1) (2457359.5 707.4582551995835)
             (:prev :rise 2457540.5 68.72044 21.2695312 1) (2457529.5 1422.3621410659048)
             (:next :set 2457540.5 68.72044 21.2695312 1) (2457590.5 1409.8061143145762)
             (:prev :rise 2457570.5 68.72044 21.2695312 1) (2457529.5 1422.3621410659048)
             (:next :set 2457570.5 68.72044 21.2695312 1) (2457590.5 1409.8061143145762)
             (:prev :rise 2457723.5 -73.32785 27.0703125 1) (2457696.5 1401.0934316545784)
             (:next :set 2457723.5 -73.32785 27.0703125 1) (2457790.5 1367.7550715817272)
             (:prev :rise 2457388.5 -73.32785 27.0703125 1) (2457331.5 1388.5662601096717)
             (:next :set 2457388.5 -73.32785 27.0703125 1) (2457425.5 1361.6595486446292)
             (:prev :rise 2457419.5 -73.32785 27.0703125 1) (2457331.5 1388.5662601096717)
             (:next :set 2457419.5 -73.32785 27.0703125 1) (2457425.5 1361.6595486446292)
             (:next :rise 2457540.5 -73.32785 27.0703125 1) (2457603.5 656.9463575332543)
             (:prev :set 2457540.5 -73.32785 27.0703125 1) (2457517.5 692.9487047206474)
             (:next :rise 2457570.5 -73.32785 27.0703125 1) (2457603.5 656.9463575332543)
             (:prev :set 2457570.5 -73.32785 27.0703125 1) (2457517.5 692.9487047206474)
             (:next :rise 2457601.5 -73.32785 27.0703125 1) (2457603.5 656.9463575332543)
             (:prev :set 2457601.5 -73.32785 27.0703125 1) (2457517.5 692.9487047206474))))

(test rise-set-utc-test
  (compare #'rise-set-utc
           '((:rise 2457449.5 52.268157 4.921875) 384.06587722244734
             (:rise 2457449.7667124146 52.268157 4.921875) 383.4718795516498
             (:set 2457449.5 52.268157 4.921875) 1040.8358236979639
             (:set 2457450.2228026553 52.268157 4.921875) 1042.146862821105
             (:rise 2457450.5 52.268157 4.921875) 381.83468123526706
             (:rise 2457450.765162973 52.268157 4.921875) 381.24121463114807
             (:set 2457450.5 52.268157 4.921875) 1042.6489964530285
             (:set 2457451.224061803 52.268157 4.921875) 1043.9589079260006
             (:rise 2457451.5 52.268157 4.921875) 379.5926859784056
             (:rise 2457451.763606032 52.268157 4.921875) 378.9999589009025
             (:set 2457451.5 52.268157 4.921875) 1044.4574673567001
             (:set 2457452.225317686 52.268157 4.921875) 1045.7662725967136
             (:rise 2457452.5 52.268157 4.921875) 377.3404865823504
             (:rise 2457452.7620420046 52.268157 4.921875) 376.7487017919554
             (:set 2457452.5 52.268157 4.921875) 1046.2612924532086
             (:set 2457453.226570342 52.268157 4.921875) 1047.5690241141613
             (:rise 2457452.5 50.625073 11.7773437) 348.33350570854606
             (:rise 2457452.741898268 50.625073 11.7773437) 347.8156545275923
             (:set 2457452.5 50.625073 11.7773437) 1020.4245237270128
             (:set 2457453.2086281413 50.625073 11.7773437) 1021.6167529749629
             (:rise 2457452.5 47.5172 15.6445312) 330.14040073353124
             (:rise 2457452.729264167 47.5172 15.6445312) 329.6956257489246
             (:set 2457452.5 47.5172 15.6445312) 1007.6801287020277
             (:set 2457453.199777867 47.5172 15.6445312) 1008.7170377989275)))

(test doy-from-jd-test
  (compare #'doy-from-jd
           '(2455987.5 61.0
             2455988.5 62.0
             2455989.5 63.0
             2455990.5 64.0
             2455991.5 65.0
             2455992.5 66.0
             2455993.5 67.0
             2455994.5 68.0
             2455995.5 69.0
             2456026.5 100.0
             2456056.5 130.0
             2456087.5 161.0
             2456117.5 191.0
             2456148.5 222.0
             2456513.5 221.0
             2456878.5 221.0
             2457243.5 221.0)))

(test leap-year-p-test
  (compare #'leap-year-p
           '(2017 nil
             2016 t
             2015 nil
             2014 nil
             2013 nil) ))

(test hour-angle-sunrise-test
  (compare #'hour-angle-sunrise
           '((49.152969 -7.502082764270422) 1.4405374631037744
             (49.152969 -7.400992522008149) 1.4426252434342919
             (49.152969 -7.226194582611582) 1.4462318802035088
             (46.437856 -7.502082764270422) 1.453333826567915
             (46.437856 -7.401582130850183) 1.4552176642328956
             (46.437856 -7.22523106740615) 1.458520384692319
             (42.163403 -7.502082764270422) 1.471158703136911
             (42.163403 -7.402476494833035) 1.4727632876306298
             (42.163403 -7.223962130120807) 1.4756367378010848
             (35.317366 -7.502082764270422) 1.495394538055158
             (35.317366 -7.403387517465036) 1.4966352634603344
             (35.317366 -7.221931112316101) 1.4989148017946885
             (36.315125 -7.502082764270422) 1.49212432608874
             (36.315125 -7.449288343476198) 1.4928131360487933
             (36.315125 -7.2683293477330535) 1.4951726987826084
             (37.996162 -7.502082764270422) 1.48643079203442
             (37.996162 -7.487215711438604) 1.4866370962511932
             (37.996162 -7.307031018780526) 1.4891361553073137)))

(test sol-noon-test
  (compare #'sol-noon
           `((,(encode-universal-time 0 0 0 28 2 2016 -1) 4.921875 -1) 772.9382579908388
             (,(encode-universal-time 0 0 0 27 2 2016 -1) 4.921875 -1) 773.1175703554873
             (,(encode-universal-time 0 0 0 27 2 2015 -1) 4.921875 -1) 773.0764739327099
             (,(encode-universal-time 0 0 0 27 2 2014 -1) 4.921875 -1) 773.0349806173041)))

(test az-el-test
  (compare-az-el 1e-15
    `((,(encode-universal-time 37 24 16 27 2 2016 6) 52.268157 4.921875 6)
      (329.6865210281012 -42.449008576548835 t -42.45531590138319 -12.727546134394334 -8.283942783133345)
      (,(encode-universal-time 37 24 16 26 2 2016 6) 52.268157 4.921875 6)
      (329.4710941599657 -42.792043989862464 t -42.798275999132954 -12.901771293127306 -8.659295697323621)
      (,(encode-universal-time 37 24 16 26 1 2016 6) 52.268157 4.921875 6)
      (324.4883632455342 -52.22896562308762 t -52.233436333511264 -12.527731653412971 -18.670180915736594)
      (,(encode-universal-time 37 24 16 26 1 2015 6) 52.268157 4.921875 6)
      (324.5067667395805 -52.166757259422326 t -52.171238002636926 -12.582072731805862 -18.608292773757267)
      (,(encode-universal-time 37 24 16 26 1 2014 6) 52.268157 4.921875 6)
      (324.5253571867718 -52.10451135688845 t -52.10900215588882 -12.635856457823186 -18.546316687175487)
      (,(encode-universal-time 37 24 15 26 1 2014 6) 52.268157 4.921875 6)
      (305.2121156096753 -45.5992051334176 t -45.60485512109295 -12.627122161351846 -18.556977731100336)
      (,(encode-universal-time 37 24 14 26 1 2014 6) 52.268157 4.921875 6)
      (289.57412636748614 -37.463648022248066 t -37.47117619523462 -12.618364520682006 -18.567629034948265)
      (,(encode-universal-time 37 23 14 26 1 2014 6) 52.268157 4.921875 6)
      (289.3373447061779 -37.31951489136452 t -37.32708240521583 -12.61821836227633 -18.567806474104632)
      (,(encode-universal-time 37 22 14 26 1 2014 6) 52.268157 4.921875 6)
      (289.1012189456595 -37.17517228174037 t -37.18277945448679 -12.618072197388335 -18.567983910553433)
      (,(encode-universal-time 36 22 14 26 1 2014 6) 52.268157 4.921875 6)
      (289.09728904006624 -37.17276481418372 t -37.180372650625486 -12.618069761166927 -18.56798686790791)
      (,(encode-universal-time 35 22 14 26 1 2014 6) 52.268157 4.921875 6)
      (289.09335931509383 -37.17035728918468 t -37.17796578941112 -12.61806732504169 -18.567989825142558)
      (,(encode-universal-time 35 22 14 26 1 2014 6) 43.707593 -71.191406 6)
      (229.14929028415344 12.103478532992625 nil 12.029699069695099 -12.61806732504169 -18.567989825142558))))

(test refraction-correction-test
  (compare #'refraction-correction
           '( ;; latbox 52.268157
             ;; lngbox 4.921875
             ;; mosbox Feb
             ;; daybox 27
             ;; yearbox 2016
             ;; hrbox 15
             ;; mnbox 45
             ;; scbox 2
             ;; zonebox -6
             -38.87499943532589 0.007157916582077719
             ;; latbox 52.268157
             ;; lngbox 4.921875
             ;; mosbox Feb
             ;; daybox 26
             ;; yearbox 2016
             ;; hrbox 15
             ;; mnbox 45
             ;; scbox 2
             ;; zonebox -6
             -39.19799923309279 0.007075904622989358
             ;; latbox 52.268157
             ;; lngbox 4.921875
             ;; mosbox Feb
             ;; daybox 26
             ;; yearbox 2015
             ;; hrbox 15
             ;; mnbox 45
             ;; scbox 2
             ;; zonebox -6
             -39.119127749631076 0.007095825650344519
             ;; latbox 52.268157
             ;; lngbox 4.921875
             ;; mosbox Feb
             ;; daybox 26
             ;; yearbox 2014
             ;; hrbox 15
             ;; mnbox 45
             ;; scbox 2
             ;; zonebox -6
             -39.04028029004945 0.007115808134402693
             ;; latbox 52.268157
             ;; lngbox 4.921875
             ;; mosbox Feb
             ;; daybox 26
             ;; yearbox 2014
             ;; hrbox 14
             ;; mnbox 45
             ;; scbox 2
             ;; zonebox -6
             -31.970925122946596 0.009245255601995895
             ;; latbox 52.268157
             ;; lngbox 4.921875
             ;; mosbox Feb
             ;; daybox 26
             ;; yearbox 2014
             ;; hrbox 13
             ;; mnbox 45
             ;; scbox 2
             ;; zonebox -6
             -23.64062833538516 0.01318279142192735
             ;; latbox 42.423456
             ;; lngbox -72.070312
             ;; mosbox Feb
             ;; daybox 26
             ;; yearbox 2014
             ;; hrbox 13
             ;; mnbox 45
             ;; scbox 2
             ;; zonebox -6
             26.82247049486211 0.03176876351615659)))

(test sun-eq-of-center-test
  (compare-within-error 1e-15 #'sun-eq-of-center
                        '( ;; latbox 52.268157
                          ;; lngbox 4.921875
                          ;; mosbox Feb
                          ;; daybox 27
                          ;; yearbox 2016
                          ;; hrbox 15
                          ;; mnbox 19
                          ;; scbox 41
                          ;; zonebox -6
                          0.16157121612543138 1.5662278920299446
                          0.16154688569472964 1.5490175208116717
                          0.16155435528286174 1.5543413473376613
                          0.16156653615437616 1.5629468279351384
                          ;; latbox 52.268157
                          ;; lngbox 4.921875
                          ;; mosbox Feb
                          ;; daybox 26
                          ;; yearbox 2016
                          ;; hrbox 15
                          ;; mnbox 19
                          ;; scbox 41
                          ;; zonebox -6
                          0.16154383761756005 1.5468348759273567
                          0.1615195071868583 1.529202098626065
                          0.16152701799407815 1.5346851291156935
                          0.16153912272133458 1.5434470726261187
                          ;; latbox 52.268157
                          ;; lngbox 4.921875
                          ;; mosbox Feb
                          ;; daybox 26
                          ;; yearbox 2015
                          ;; hrbox 15
                          ;; mnbox 19
                          ;; scbox 41
                          ;; zonebox -6
                          0.1515506822445279 1.5519554692763924
                          0.15152635181382615 1.5344314469064932
                          0.15153385262351168 1.5398737995794591
                          0.15154597591384378 1.5485949613017653
                          ;; latbox 52.268157
                          ;; lngbox 4.921875
                          ;; mosbox Feb
                          ;; daybox 26
                          ;; yearbox 2014
                          ;; hrbox 15
                          ;; mnbox 19
                          ;; scbox 41
                          ;; zonebox -6
                          0.1415575268714957 1.557044192124587
                          0.14153319644079398 1.539629268267578
                          0.14154068725409266 1.5450309263889856
                          0.1415528290894604 1.5537109562667666)))

(test sun-true-anomaly-test
  (compare #'sun-true-anomaly
           '( ;; latbox 52.268157
             ;; lngbox 4.921875
             ;; mosbox Feb
             ;; daybox 27
             ;; yearbox 2016
             ;; hrbox 15
             ;; mnbox 6
             ;; scbox 22
             ;; zonebox -6
             0.16157096293760612 6175.496376926758
             ;; latbox 52.268157
             ;; lngbox 4.921875
             ;; mosbox Feb
             ;; daybox 26
             ;; yearbox 2016
             ;; hrbox 15
             ;; mnbox 6
             ;; scbox 22
             ;; zonebox -6
             0.1615435844297348 6174.491379211962
             ;; latbox 52.268157
             ;; lngbox 4.921875
             ;; mosbox Feb
             ;; daybox 26
             ;; yearbox 2015
             ;; hrbox 15
             ;; mnbox 6
             ;; scbox 22
             ;; zonebox -6
             0.15155042905670263 5814.752398594368
             ;; latbox 52.268157
             ;; lngbox 4.921875
             ;; mosbox Feb
             ;; daybox 26
             ;; yearbox 2014
             ;; hrbox 15
             ;; mnbox 6
             ;; scbox 22
             ;; zonebox -6
             0.14155727368367046 5455.0133860791075)))

(test sun-rad-vector-test
  (compare #'sun-rad-vector
           '( ;; latbox 52.268157
             ;; lngbox 4.921875
             ;; mosbox Feb
             ;; daybox 27
             ;; yearbox 2016
             ;; hrbox 15
             ;; mnbox 3
             ;; scbox 10
             ;; zonebox -6
             0.1615709020964888 0.9903519186072487
             ;; latbox 52.268157
             ;; lngbox 4.921875
             ;; mosbox Feb
             ;; daybox 26
             ;; yearbox 2016
             ;; hrbox 15
             ;; mnbox 3
             ;; scbox 10
             ;; zonebox -6
             0.16154352358861748 0.9901165656478029
             ;; latbox 52.268157
             ;; lngbox 4.921875
             ;; mosbox Feb
             ;; daybox 26
             ;; yearbox 2015
             ;; hrbox 15
             ;; mnbox 3
             ;; scbox 10
             ;; zonebox -6
             0.15155036821558532 0.9901771505041198
             ;; latbox 52.268157
             ;; lngbox 4.921875
             ;; mosbox Feb
             ;; daybox 26
             ;; yearbox 2014
             ;; hrbox 15
             ;; mnbox 3
             ;; scbox 10
             ;; zonebox -6
             0.14155721284255313 0.9902379346153758)))

(test sun-true-long-test
  (compare #'sun-true-long
           '( ;; latbox 52.268157
             ;; lngbox 4.921875
             ;; mosbox Feb
             ;; daybox 27
             ;; yearbox 2016
             ;; hrbox 14
             ;; mnbox 58
             ;; scbox 56
             ;; zonebox -6
             0.1615708216087361 338.7063797384734
             0.16154688569472964 337.8277340828228
             0.16155435528286174 338.1019688331496
             0.16156653615437616 338.5490950666593
             ;; latbox 52.268157
             ;; lngbox 4.921875
             ;; mosbox Feb
             ;; daybox 26
             ;; yearbox 2016
             ;; hrbox 14
             ;; mnbox 58
             ;; scbox 56
             ;; zonebox -6
             0.16154344310086477 337.7013324751038
             0.1615195071868583 336.82227129779113
             0.16152701799407815 337.09814917097503
             0.16153912272133458 337.5426906154846
             ;; latbox 52.268157
             ;; lngbox 4.921875
             ;; mosbox Feb
             ;; daybox 26
             ;; yearbox 2014
             ;; hrbox 14
             ;; mnbox 58
             ;; scbox 56
             ;; zonebox -6
             0.14155713235480044 338.1889705856484
             0.14153319644079398 337.31012371106084
             0.14154068725409266 337.5852004152304
             0.1415528290894604 338.03099586653775
             ;; latbox 52.268157
             ;; lngbox 4.921875
             ;; mosbox Feb
             ;; daybox 26
             ;; yearbox 2015
             ;; hrbox 14
             ;; mnbox 58
             ;; scbox 56
             ;; zonebox -6
             0.1515502877278326 337.9451674325965
             0.15152635181382615 337.0662132376072
             0.15153385262351168 337.3416905139977
             0.15154597591384378 337.7868594616617)))

(test sun-apparent-long-test
  (compare #'sun-apparent-long
           '( ;; latbox 52.268157
             ;; lngbox 4.921875
             ;; mosbox Feb
             ;; daybox 27
             ;; yearbox 2016
             ;; hrbox 14
             ;; mnbox 55
             ;; scbox 17
             ;; zonebox -6
             0.16157075221183048 338.6975222374805
             0.16154688569472964 337.82142731082087
             0.16155435528286174 338.0956608659602
             0.16156653615437616 338.54278515052766
             ;; latbox 52.268157
             ;; lngbox 4.921875
             ;; mosbox Feb
             ;; daybox 26
             ;; yearbox 2016
             ;; hrbox 14
             ;; mnbox 55
             ;; scbox 17
             ;; zonebox -6
             0.16154337370395916 337.6924781438681
             0.1615195071868583 336.8159689068808
             0.16152701799407815 337.09184557813785
             0.16153912272133458 337.53638508565547
             ;; latbox 52.268157
             ;; lngbox 4.921875
             ;; mosbox Feb
             ;; daybox 26
             ;; yearbox 2015
             ;; hrbox 14
             ;; mnbox 55
             ;; scbox 17
             ;; zonebox -6
             0.151550218330927 337.93791701524646
             0.15152635181382615 337.061514397335
             0.15153385262351168 337.3369904896787
             0.15154597591384378 337.7821575234761)))
  
(test sun-declination-test
  (compare #'sun-declination
           '( ;; latbox 52.268157
             ;; lngbox 4.921875
             ;; mosbox Feb
             ;; daybox 27
             ;; yearbox 2016
             ;; hrbox 14
             ;; mnbox 53
             ;; scbox 22
             ;; zonebox -6
             0.16157071577052315 -8.307789442751368
             0.16154688569472964 -8.63449776410355
             0.16155435528286174 -8.532260454495097
             0.16156653615437616 -8.365205049310239
             ;; latbox 52.268157
             ;; lngbox 4.921875
             ;; mosbox Feb
             ;; daybox 26
             ;; yearbox 2016
             ;; hrbox 14
             ;; mnbox 53
             ;; scbox 22
             ;; zonebox -6
             0.16154333726265185 -8.683010265194635
             0.1615195071868583 -9.007858951748926
             0.16152701799407815 -8.905652277924897
             0.16153912272133458 -8.740582695660143
             ;; latbox 52.268157
             ;; lngbox 4.921875
             ;; mosbox Feb
             ;; daybox 26
             ;; yearbox 2015
             ;; hrbox 14
             ;; mnbox 53
             ;; scbox 22
             ;; zonebox -6
             0.15155018188961966 -8.591645772592873
             0.15152635181382615 -8.916957732089388
             0.15153385262351168 -8.814739158867638
             0.15154597591384378 -8.649181507404961
             ;; latbox 52.268157
             ;; lngbox 4.921875
             ;; mosbox Feb
             ;; daybox 26
             ;; yearbox 2014
             ;; hrbox 14
             ;; mnbox 53
             ;; scbox 22
             ;; zonebox -6
             0.1415570265165875 -8.50029404166402
             0.14153319644079398 -8.826067156888776
             0.14154068725409266 -8.72383773075347
             0.1415528290894604 -8.55779261412208)))

(test geom-mean-anomaly-sun-test
  (compare #'geom-mean-anomaly-sun
           '( ;; latbox 52.268157
             ;; lngbox 4.921875
             ;; mosbox Feb
             ;; daybox 27
             ;; yearbox 2016
             ;; hrbox 14
             ;; mnbox 49
             ;; scbox 24
             ;; zonebox -6
             0.16157064035287527 6173.91871343831
             0.16154651137919232 6173.0500933024505
             0.161560445762852 6173.551717879884
             0.16154688569472964 6173.063568306284
             0.16155435528286174 6173.332466384726
             0.16156653615437616 6173.7709661903455
             ;; latbox 52.268157
             ;; lngbox 4.921875
             ;; mosbox Feb
             ;; daybox 26
             ;; yearbox 2016
             ;; hrbox 14
             ;; mnbox 49
             ;; scbox 24
             ;; zonebox -6
             0.16154326184500395 6172.933113157946
             0.16151913287132103 6172.064493022087
             0.16153307039947246 6172.566230798236
             0.1615195071868583 6172.077968025919
             0.16152701799407815 6172.348349952371
             0.16153912272133458 6172.784108637021
             ;; latbox 52.268157
             ;; lngbox 4.921875
             ;; mosbox Feb
             ;; daybox 26
             ;; yearbox 2015
             ;; hrbox 14
             ;; mnbox 49
             ;; scbox 24
             ;; zonebox -6
             0.15155010647197176 5813.189010809271
             0.15152597749828883 5812.320390673338
             0.15153991431106215 5812.822102696597
             0.15152635181382615 5812.333865677173
             0.15153385262351168 5812.603887701908
             0.15154597591384378 5813.040314639688
             ;; latbox 52.268157
             ;; lngbox 4.921875
             ;; mosbox Feb
             ;; daybox 26
             ;; yearbox 2014
             ;; hrbox 14
             ;; mnbox 49
             ;; scbox 24
             ;; zonebox -6
             0.1415569510989396 5453.4449084299
             0.14153282212525667 5452.5762882938925
             0.14154675821477292 5453.077974280627
             0.14153319644079398 5452.5897632977285
             0.14154068725409266 5452.859425462055
             0.1415528290894604 5453.296520003542)))

(test eccentricity-earth-orbit-test
  (compare #'eccentricity-earth-orbit
           '( ;; latbox 52.268157
             ;; lngbox 4.921875
             ;; mosbox Feb
             ;; daybox 27
             ;; yearbox 2016
             ;; hrbox 14
             ;; mnbox 45
             ;; scbox 23
             ;; zonebox -6
             0.16157056398458988 0.016701838750692307
             0.16154651137919232 0.016701839762776366
             0.161560445762852 0.01670183917644624
             0.16154688569472964 0.01670183974702594
             0.16155435528286174 0.016701839432721084
             0.16156653615437616 0.01670183892017511
             ;; latbox 52.268157
             ;; lngbox 4.921875
             ;; mosbox Feb
             ;; daybox 26
             ;; yearbox 2016
             ;; hrbox 14
             ;; mnbox 45
             ;; scbox 23
             ;; zonebox -6
             0.16154318547671856 0.016701839902723475
             0.16151913287132103 0.01670184091480737
             0.16153307039947246 0.016701840328345027
             0.1615195071868583 0.01670184089905695
             0.16152701799407815 0.016701840583017727
             0.16153912272133458 0.016701840073675832
             ;; latbox 52.268157
             ;; lngbox 4.921875
             ;; mosbox Feb
             ;; daybox 26
             ;; yearbox 2015
             ;; hrbox 14
             ;; mnbox 45
             ;; scbox 23
             ;; zonebox -6
             0.1515500301036864 0.016702260381413477
             0.15152597749828883 0.016702261393436463
             0.15153991431106215 0.016702260807039515
             0.15152635181382615 0.01670226137768699
             0.15153385262351168 0.01670226106208744
             0.15154597591384378 0.016702260551995148
             ;; latbox 52.268157
             ;; lngbox 4.921875
             ;; mosbox Feb
             ;; daybox 26
             ;; yearbox 2014
             ;; hrbox 14
             ;; mnbox 45
             ;; scbox 23
             ;; zonebox -6
             0.14155687473065423 0.016702680834798155
             0.14153282212525667 0.016702681846760235
             0.14154675821477292 0.016702681260429005
             0.14153319644079398 0.016702681831011708
             0.14154068725409266 0.01670268151585173
             0.1415528290894604 0.016702681005009892)))

(test geom-mean-long-sun-test
  (compare #'geom-mean-long-sun
           '( ;; latbox 52.268157
             ;; lngbox 4.921875
             ;; mosbox Feb
             ;; daybox 27
             ;; yearbox 2016
             ;; hrbox 14
             ;; mnbox 40
             ;; scbox 39
             ;; zonebox -6
             0.1615704739904114 337.1279133678445
             0.16154651137919232 336.2652409144721
             0.161560445762852 336.7668894546923
             0.16154688569472964 336.27871656201114
             0.16155435528286174 336.547627485812
             0.16156653615437616 336.9861482387241
             ;; latbox 52.268157
             ;; lngbox 4.921875
             ;; mosbox Feb
             ;; daybox 26
             ;; yearbox 2016
             ;; hrbox 14
             ;; mnbox 40
             ;; scbox 39
             ;; zonebox -6
             0.1615430954825401 336.1422660049975
             0.16151913287132103 335.279593551626
             0.16153307039947246 335.78135529597057
             0.1615195071868583 335.2930691991651
             0.16152701799407815 335.56346404185933
             0.16153912272133458 335.9992435428585
             ;; latbox 52.268157
             ;; lngbox 4.921875
             ;; mosbox Feb
             ;; daybox 26
             ;; yearbox 2015
             ;; hrbox 14
             ;; mnbox 40
             ;; scbox 39
             ;; zonebox -6
             0.15154994010950792 336.3809785963904
             0.15152597749828883 335.5183061431635
             0.15153991431106215 336.0200421332602
             0.15152635181382615 335.53178179070073
             0.15153385262351168 335.80181671441824
             0.15154597591384378 336.23826450035995
             ;; latbox 52.268157
             ;; lngbox 4.921875
             ;; mosbox Feb
             ;; daybox 26
             ;; yearbox 2014
             ;; hrbox 14
             ;; mnbox 40
             ;; scbox 39
             ;; zonebox -6
             0.14155678473647573 336.6196912483383
             0.14153282212525667 335.7570187952588
             0.14154675821477292 336.2587287474589
             0.14153319644079398 335.7704944427933
             0.14154068725409266 336.04016948884146
             0.1415528290894604 336.477284910271)))

(test obliquity-correction-test
  (compare #'obliquity-correction
           '( ;; latbox 52.268157
             ;; lngbox 4.921875
             ;; mosbox Feb
             ;; daybox 27
             ;; yearbox 2016
             ;; hrbox 14
             ;; mnbox 35
             ;; scbox 48
             ;; zonebox -6
             0.1615703817780788 23.434651684011225
             0.16154651137919232 23.434651727456885
             0.161560445762852 23.434651701895167
             0.16154688569472964 23.434651726762887
             0.16155435528286174 23.434651712998658
             0.16156653615437616 23.43465169089913
             ;; latbox 52.268157
             ;; lngbox 4.921875
             ;; mosbox Feb
             ;; daybox 26
             ;; yearbox 2016
             ;; hrbox 14
             ;; mnbox 35
             ;; scbox 48
             ;; zonebox -6
             0.16154300327020749 23.434651733980793
             0.16151913287132103 23.434651779317036
             0.16153307039947246 23.434651752645703
             0.1615195071868583 23.434651778593388
             0.16152701799407815 23.434651764158758
             0.16153912272133458 23.43465174123878
             ;; latbox 52.268157
             ;; lngbox 4.921875
             ;; mosbox Feb
             ;; daybox 26
             ;; yearbox 2015
             ;; hrbox 14
             ;; mnbox 35
             ;; scbox 48
             ;; zonebox -6
             0.15154984789717532 23.434815549341447
             0.15152597749828883 23.434816286708763
             0.15153991431106215 23.43481585599681
             0.15152635181382615 23.43481627513344
             0.15153385262351168 23.434816043262863
             0.15154597591384378 23.434815668838244
             ;; latbox 52.268157
             ;; lngbox 4.921875
             ;; mosbox Feb
             ;; daybox 26
             ;; yearbox 2014
             ;; hrbox 14
             ;; mnbox 35
             ;; scbox 48
             ;; zonebox -6
             0.14155669252414316 23.435261710476887
             0.14153282212525667 23.435263091748023
             0.14154675821477292 23.43526228515747
             0.14153319644079398 23.435263070077127
             0.14154068725409266 23.43526263647195
             0.1415528290894604 23.435261933939866)))

(test time-julian-cent-test
  (compare #'time-julian-cent
           '( ;; latbox 52.268157
             ;; lngbox 4.921875
             ;; mosbox Feb
             ;; daybox 27
             ;; yearbox 2016
             ;; hrbox 12
             ;; mnbox 28
             ;; scbox 28
             ;; zonebox -6
             2457446.2697685184 0.16156796080816963
             2457445.486328125 0.16154651137919232
             2457445.995281488 0.161560445762852
             2457445.5 0.16154688569472964
             2457445.7728267065 0.16155435528286174
             2457446.2177330386 0.16156653615437616
             ;; latbox 52.268157
             ;; lngbox 4.921875
             ;; mosbox Feb
             ;; daybox 26
             ;; yearbox 2016
             ;; hrbox 12
             ;; mnbox 28
             ;; scbox 28
             ;; zonebox -6
             2457445.2697685184 0.1615405823002983
             2457444.486328125 0.16151913287132103
             2457444.9953963407 0.16153307039947246
             2457444.5 0.1615195071868583
             2457444.7743322337 0.16152701799407815
             2457445.2164573967 0.16153912272133458
             ;; latbox 52.268157
             ;; lngbox 4.921875
             ;; mosbox Feb
             ;; daybox 26
             ;; yearbox 2015
             ;; hrbox 12
             ;; mnbox 28
             ;; scbox 28
             ;; zonebox -6
             2457080.2697685184 0.15154742692726614
             2457079.486328125 0.15152597749828883
             2457079.9953702115 0.15153991431106215
             2457079.5 0.15152635181382615
             2457079.7739670738 0.15153385262351168
             2457080.216770253 0.15154597591384378
             ;; latbox 52.268157
             ;; lngbox 4.921875
             ;; mosbox Feb
             ;; daybox 26
             ;; yearbox 2014
             ;; hrbox 12
             ;; mnbox 28
             ;; scbox 28
             ;; zonebox -6
             2456715.2697685184 0.14155427155423397
             2456714.486328125 0.14153282212525667
             2456714.9953437946 0.14154675821477292
             2456714.5 0.14153319644079398
             2456714.7736019557 0.14154068725409266
             2456715.2170824925 0.1415528290894604)))

(test time-local-test
  (compare #'time-local 
           `( ;; latbox 52.268157
             ;; lngbox 4.921875
             ;; mosbox Feb
             ;; daybox 28
             ;; yearbox 2016
             ;; scbox 33
             ;; mnbox 21
             ;; hrbox 11
             ;; hrbox 11
             ;; mnbox 21
             ;; scbox 33
             ;; zonebox -6
             ,(encode-universal-time 33 21 11  26 2 2016 ) 681.55
             ;; latbox 52.268157
             ;; lngbox 4.921875
             ;; mosbox Feb
             ;; daybox 28
             ;; yearbox 2016
             ;; scbox 33
             ;; mnbox 21
             ;; hrbox 19
             ;; hrbox 19
             ;; mnbox 21
             ;; scbox 33
             ;; zonebox -6
             ,(encode-universal-time 33 21 19  26 2 2016 ) 1161.55
             ;; latbox 52.268157
             ;; lngbox 4.921875
             ;; mosbox Feb
             ;; daybox 28
             ;; yearbox 2016
             ;; scbox 33
             ;; mnbox 20
             ;; hrbox 19
             ;; hrbox 19
             ;; mnbox 20
             ;; scbox 33
             ;; zonebox -6
             ,(encode-universal-time 33 20 19  26 2 2016 ) 1160.55
             ;; latbox 52.268157
             ;; lngbox 4.921875
             ;; mosbox Feb
             ;; daybox 28
             ;; yearbox 2016
             ;; scbox 32
             ;; mnbox 20
             ;; hrbox 19
             ;; hrbox 19
             ;; mnbox 20
             ;; scbox 32
             ;; zonebox -6
             ,(encode-universal-time 32 20 19  26 2 2016 ) 1160.5333333333333)))


(test jd-test
  (compare #'jd
           `( ;; latbox 52.268157
             ;; lngbox 4.921875
             ;; mosbox Feb
             ;; daybox 26
             ;; yearbox 2016
             ;; mosbox Feb
             ;; daybox 26
             ;; yearbox 2016
             ;; hrbox 16
             ;; mnbox 59
             ;; scbox 48
             ;; zonebox -6
             ,(encode-universal-time 0 0 0 26 2 2016) 2457444.5
              ;; latbox 52.268157
              ;; lngbox 4.921875
              ;; mosbox Feb
              ;; daybox 25
              ;; yearbox 2016
              ;; mosbox Feb
              ;; daybox 25
              ;; yearbox 2016
              ;; hrbox 16
              ;; mnbox 59
              ;; scbox 48
              ;; zonebox -6
             ,(encode-universal-time 0 0 0 25 2 2016) 2457443.5
              ;; latbox 52.268157
              ;; lngbox 4.921875
              ;; mosbox Feb
              ;; daybox 25
              ;; yearbox 2015
              ;; mosbox Feb
              ;; daybox 25
              ;; yearbox 2015
              ;; hrbox 16
              ;; mnbox 59
              ;; scbox 48
              ;; zonebox -6
             ,(encode-universal-time 0 0 0 25 2 2015) 2457078.5
              ;; latbox 52.268157
              ;; lngbox 4.921875
              ;; mosbox Feb
              ;; daybox 25
              ;; yearbox 2014
              ;; mosbox Feb
              ;; daybox 25
              ;; yearbox 2014
              ;; hrbox 16
              ;; mnbox 59
              ;; scbox 48
              ;; zonebox -6
             ,(encode-universal-time 0 0 0 25 2 2014) 2456713.5)))

(test mean-obliquity-of-ecliptic-test
  (compare #'mean-obliquity-of-ecliptic
           '( ;; latbox 52.268157
             ;; lngbox 4.921875
             ;; mosbox Feb
             ;; daybox 26
             ;; yearbox 2016
             ;; hrbox 16
             ;; mnbox 17
             ;; scbox 21
             ;; zonebox -6
             0.16154493402540532 23.437190351711042
             0.16151913287132103 23.4371906872339
             0.16153307039947246 23.437190505987772
             0.1615195071868583 23.437190682366232
             0.16152701799407815 23.437190584694342
             0.16153912272133458 23.43719042728229
             ;; latbox 52.268157
             ;; lngbox 4.921875
             ;; mosbox Feb
             ;; daybox 25
             ;; yearbox 2016
             ;; hrbox 16
             ;; mnbox 17
             ;; scbox 21
             ;; zonebox -6
             0.161517555517534 23.437190707746094
             0.1614917543634497 23.43719104326895
             0.16150569485327068 23.43719086198431
             0.161492128678987 23.437191038401284
             0.16149968042844762 23.437190940196974
             0.16151170919962293 23.437190783772664
             ;; latbox 52.268157
             ;; lngbox 4.921875
             ;; mosbox Feb
             ;; daybox 25
             ;; yearbox 2015
             ;; hrbox 16
             ;; mnbox 17
             ;; scbox 21
             ;; zonebox -6
             0.1515244001445018 23.43732066054677
             0.1514985989904175 23.437320996069666
             0.1515125388103492 23.437320814793715
             0.15149897330595483 23.437320991201997
             0.1515065151270196 23.43732089312679
             0.1515185624139331 23.43732073646168
             ;; latbox 52.268157
             ;; lngbox 4.921875
             ;; mosbox Feb
             ;; daybox 25
             ;; yearbox 2014
             ;; hrbox 16
             ;; mnbox 17
             ;; scbox 21
             ;; zonebox -6
             0.14153124477146964 23.43745061336044
             0.14150544361738535 23.437450948883363
             0.14151938275933204 23.437450767616212
             0.14150581793292266 23.437450944015694
             0.14151334982659874 23.437450846069574
             0.141525415611083 23.437450689163907)))


(test equation-of-time-test
  (compare-within-error 1e-15 #'equation-of-time
                        '( ;; latbox 52.268157
                          ;; lngbox 4.921875
                          ;; mosbox Feb
                          ;; daybox 26
                          ;; yearbox 2016
                          ;; hrbox 14
                          ;; mnbox 13
                          ;; scbox 33
                          ;; zdddonebox -1
                          0.16153687637842412 -12.952124005310553
                          0.16151913287132103 -13.058230904333714
                          0.16153307039947246 -12.975220168940533
                          0.1615195071868583 -13.056033906862655
                          0.16152701799407815 -13.011571432583105
                          0.1615195071868583 -13.056033906862655
                          0.16153912272133458 -12.938406795393341
                          ;; latbox 52.268157
                          ;; lngbox 4.921875
                          ;; mosbox Feb
                          ;; daybox 25
                          ;; yearbox 2016
                          ;; hrbox 14kq 
                          ;; mnbox 13
                          ;; scbox 33
                          ;; zonebox -1
                          0.1615094978705528 -13.11416153186873
                          0.1614917543634497 -13.21400255786138
                          0.16150569485327068 -13.13590718664338
                          0.161492128678987 -13.21193901251694
                          0.16149968042844762 -13.169912928787184
                          0.161492128678987 -13.21193901251694
                          0.16151170919962293 -13.101430869386835
                          ;; latbox 52.268157
                          ;; lngbox 4.921875
                          ;; mosbox Feb
                          ;; daybox 25
                          ;; yearbox 2015
                          ;; hrbox 14
                          ;; mnbox 13
                          ;; scbox 33
                          ;; zonebox -1
                          0.15151634249752063 -13.077369181436852
                          0.1514985989904175 -13.178768799454845
                          0.1515125388103492 -13.099450283406103
                          0.15149897330595483 -13.176672070869978
                          0.1515065151270196 -13.134035923194999
                          0.15149897330595483 -13.176672070869978
                          0.1515185624139331 -13.064396039132594
                          ;; latbox 52.268157
                          ;; lngbox 4.921875
                          ;; mosbox Feb
                          ;; daybox 25
                          ;; yearbox 2014
                          ;; hrbox 14
                          ;; mnbox 13
                          ;; scbox 33
                          ;; zonebox -1
                          0.14152318712448844 -13.040158841251882
                          0.14150544361738535 -13.143109930842531
                          0.14151938275933204 -13.062574020570727
                          0.14150581793292266 -13.140980168271035
                          0.14151334982659874 -13.09773870767321
                          0.14150581793292266 -13.140980168271035
                          0.141525415611083 -13.026942730167162)))

;; (run! 'tests)

(eval-when (:compile-toplevel :load-toplevel :execute)
  (setf *read-default-float-format* *previous-read-default-float-format*))
